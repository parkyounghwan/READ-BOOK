# 2021-04-18

## 웹 애플리케이션의 새로운 IoC 컨테이너 구성

루트 컨텍스트와 서블릿 애플리케이션 컨텍스트는 각각 web.xml의 와 에 컨텍스트의 설정 관련 정보를넣어 웹 애플리케이션이 시작될 때 자동으로 생성되게 만든다.

* 루트 애플리케이션 컨텍스트 등록

  를 등로해주면 디폴트 컨텍스트 클래스인 XmlWebApplicationContext를 이용해 애플리케이션 컨텍스트를 만들고 /WEB/INF/applicationContext.xml을 설정파일로 사용한다.

* 서블릿 컨텍스트 등록

  서블릿 컨텍스트는 DispatcherServlet 서블릿을 등록하면 만들어진다. 루트 애플리케이션 컨텍스트와 동일하게 XmlWebApplicationContext가 디폴트 컨텍스트 클래스다.

XML을 기준 설정정보로 사용하는 경우에 @Bean 메소드를 가진 `@Configuration` 클래스를 이용하려면 다음과 같이 `@Confioguration` 클래스를 으로 등록하고 이나 을 반드시 넣어줘야 했지만 AnnotationConfigContext에서는 `@Configuration` 빈을 지정하는 것으로 충분하다. 왜냐하면 AnnotationConfigWebApplicationContext는 이 등록해주는 빈을 기본적으로 추가해주기 때문이다. 따라서 별도의 설정 없이도 애노테이션을 이용하는 각종 스프링 빈 설정 방법을 사용할 수 있다.

스프링 시큐리티 같은 스프링 서브 프로젝트나 스프링 외의 라이브러리가 제공하는 전용 태그를 사용해야만 한다면 별도의 XML파일을 만들고 AppConfig에 `@ImportResource`를 넣어서 XML 설정을 `@Configuration`클래스가 가져와 사용하는 구조로 만들어주면 된다.

## 런타임 환경 추상화와 프로파일

스프링의 빈 설정 메타정보는 빈의 클래스와 값 속성, 다른 빈과의 관계로 이뤄져 있다. 애플리케이션의 기능이 바뀌지 않는다면 메타정보도 대부분 바뀌지 않는다. 하지만 애플리케이션이동작하는 환경에 따라서 바뀌어야 하는 것도 있다.

**환경에 따른 빈 설정정보 변경 전략과 한계**

애플리케이션이 실행되는 환경이 달라지면 일부 빈은 환경에 맞게 설정 메타정보를 다르게 구성해야 한다.

* 빈 설정파일의 변경

  메타정보를 담은 XML이나 클래스를 따로 준비하고 각 환경에서 스프링 애플리케이션을 실행할 때 다른 설정파일을 사용하게 만든다. 하지만 개발이나 유지보수가 계속 진행되면서 설정정보가 지속적으로 달라지는 경우라면 이렇게 조금씩 내용이 다른 여러 벌의 설정 메타정보를 관리하는 것은 번거롭고 위험하다.

* 프로퍼티 파일 활용

  환경에 따라 달라지는 정보를 담은 프로퍼티 파일을 활용하는 방법. 빈 설정 메타정보를 담은 XML이나 `@Configuration` 클래스는 애플리케이션 로직이 바뀌지 않는 한 건드리지 않고 환경에 따라 달라지는 외부 정보만 프로퍼티 파일등에 두고 XML에서 읽어서 사용하는 방법.

  프로퍼티 파일만 별도로 준비하는 경우 소스코드를 배포할 때 프로퍼티 파일을 포함하지 않도록 주의해야한다.

  각 환경에서 빈 메타정보 자체가 바뀌는 경우에는 프로퍼티 파일과 프로퍼티 치환자를 이용한 방법으로는 환경에 따라 설정이 바뀌는 문제를 간단히 해결할 수가 없다.

**런타임 환경과 프로파일**

런타임 환경은 애플리케이션 컨텍스트에 새롭게 도입된 개념이다. 환경에 따라 프로파일과 프로퍼티 소스가 다르게 설정된 Environment 오브젝트가 사용되는 방법이다.

환경에 따라 다르게 구성되는 빈들을 다른 이름을 가진 프로파일 안에 정의한다. 그리고 애플리케이션 컨텍스트가 시작될 때 지정된 프로파일에 속한 빈들만 생성되게 하는 것이다. 환경에 따라 다른 프로파일을 활성화하면 각기 다른 빈들이 사용되는 것이다.

