# 2021-04-11

## 스프링 3.1의 IoC 컨테이너와 DI

스프링 3.1에 새롭게 도입된 IoC/DI 기술은 다음 두 가지다.

* 강화된 자바 코드 빈 설정
* 런타임 환경 추상화

첫 번째는 자바 코드를 이용한 설정 방식을 빈 설정 메타정보 작성에 본격적으로 사용할 수 있도록 기능을 대폭 확장한 것이다. 두 번째 런타임 환경 추상화는 개발과 테스트, 운영 단계에서 IoC/DI 구성이 달라질 때 이를 효과적으로 관리할 수 있게 해주는 런타임 환경정보 관리 기능이다.

스프링은 완벽에 가까운 구 버전 호환성을 유지하고 있으므로 스프링 3.1을 사용한다고 기존의 IoC/DI 방식을 버리고 새로운 방법으로 바꿀 필요는 없다.

스프링 3.1의 가장 큰 특징은 자바 코드를 이용한 설정 메타정보 작성이 쉽다는 점이다. 그래서 XML을 사용하지 않거나 최소화한 채로 스프링 애플리케이션 개발이 가능하다.

### 빈의 역할과 구분

**빈의 종류**

* **애플리케이션 로직 빈**

  스프링에서 말하는 빈은 스프링 IoC/DI 컨테이너에 의해 생성되고 관리되는 오브젝트다. 일반적으로 애플리케이션의 로직을 담고 있는 주요 클래스의 오브젝트가 빈으로 지정된다.

* **애플리케이션 인프라 빈**

  DataSource 오브젝트는 여러 DAO 빈과 관계를 맺고 사용된다. 구현 클래스가 여러 가지여서 하나를 지정해야하고 연결 방법과 관련된 속성은 코드 외부에서 제공하는 경우가 일반적이다. DataSource 빈은 애플리케이션의 로직을 직접 담당하지 않는다.

  이런 빈의 특징은 애플리케이션의 로직 빈을 지원한다.

* **컨테이너 인프라 빈**

  DefaultAdvisorAutoProxyCreator는 Advisor 타입빈의 포인트컷 정보를 이용해서 타깃 빈을 선정하고, 선정된 빈을 프록시로 바꿔주는 기능을 담당한다. 스프링 컨테이너가 빈을 생성할 때 프록시 생성 같은 특별한 작업을 하도록 지원한다.

  스프링 IoC/DI 컨테이너의 기능을 확장하는 방법은 확장 기능을 가진 오브젝트를 스프링의 빈으로 등록하는 것이다.

  스프링 컨테이너의 기능을 확장해서 빈의 등록과 생성, 관계설정, 초기화 등의 작업에 참여하는 빈이다.

* **컨테이너 인프라 빈과 전용 태그**

  스프링은 이런 빈을 개발자가 XML에 직접 등록하는 대신 전용 태그를 사용해 간접적으로 동록하는 방법을 권한다.

  `@Component`를 붙이면 빈 스캐너를 통해 빈으로 등록되게 만들 수 있다. `@Configuration`애노테이션은 자신이 빈으로 등록되면서 동시에 `@Bean`이 붙은 메소드의 리턴 오브젝트도 빈으로 등록해준다.

  `@Configuration` / `@Bean` 은 물론이고 @Autowired 같은 애노테이션을 이용한 빈 의존관계 설절 방식, `@PostConstruct`를 통한 빈 초기화 메소드 기능 모두 스프링 컨테이너가 기본적으로 제공하는 기능이 아니다. 스프링 컨테이너의 기능을 확장할 수 있는 컨테이너 인프라 빈이 제공하는 기능일 뿐이다.

   태그는 context 네임스페이스의 태그를 처리하는 핸들러를 통해 특정 빈이 등록되게 해준다. 이 과정에서 등록되는 빈이 스프링 컨테이너를 확장해서 빈의 등록과 관계 설정, 후처리 등에 새로운 기능을 부여하는 컨테이너 인프라 빈이다.

  ConfigurationClassPostProcessor는 `@Configuration`과 `@Bean`을 이용해 새로운 빈을 등록하는 역할을 맡는다. AutowiredAnnotationBeanPostProcessor는 `@Autowired`가 붙은 필드를 찾아서 빈 의존관계를 설정해준다. CommonAnnotationBeanPostProcessor는 `@PostConstruct`가 붙은 메소드를 빈이 초기화된 뒤에 호출해주는 기능을 제공한다.

  컨테이너 인프라 빈은 일반 애플리케이션 개발자가 직접 개발해서 추가할 일이 거의 없고, 일정한 설정 패턴이 있기 때문에 전용 태그로 등록하고 애트리뷰트를 통해 필요한 속성만 부여하도록 하는 것이 일반적이다.

   태그는 빈 스캐너 기능을 제공할 뿐만 아니라 에 의해 등록되는 빈들도 등록해준다.

**빈의 역할**

웹 환경에서 애플리케이션 컨텍스트는 web.xml의 설정에 따라 루트 애플리케이션 컨텍스트나 서블릿 컨텍스트 형태로 만들어진다. 서버환경에서 만들어지는 루트 애플리케이션 컨텍스트에 어떤 빈이 등록되어 있는지 살펴보고 싶다면 web.xml 설정에 따라 만들어지는 애플리케이션 컨텍스트를 가져와 살펴보는 코드를 만들어야 한다.

BeanDefinition에는 다음과 같은 3개의 역할이 정의되어 있다.

```java
int ROLE_APPLICATION = 0;
int ROLE_SUPPORT = 1;
int ROLE_INFRASTRUCUTRE = 2;
```

ROLE\_APPLICATION은 애플리케이션 로직 빈과 애플리케이션 인프라 빈처럼 애플리케이션이 동작하는 중에 사용되는 빈을 말한다.

ROLE\_SUPPORT는 복합 구조의 빈을 정의할 때 보조적으로 사용되는 빈의 역할을 지정하려고 정의된 것이다.

ROLE\_INFRASTRUCTURE는  같은 전용 태그에 의해 등록되는 컨테이너 인프라 빈들이 바로 이 ROLE\_INFRASTRUCTURE 값을 갖고 있다. 다른 애플리케이션 빈과 역할과 특성이 명확히 다르기 때문에 이를 구분하고자 빈 메타정보의 속성을 통해 구분해둔 것이다.

스프링에서 사용되는 빈을 역할과 성격에 따라서 구분하면 빈 메타정보의 역할 속성을 기준으로 애플리케이션 빈과 인프라 빈\(컨테이너 인프라 빈\)으로 나눌 수 있다.

다시 애플리케이션 빈을 구분하면, 개발자가 직접 작성하는 애플리케이션 로직 빈과 스프링 또는 외부 라이브러리에서 제공하는 클래스가 주로 사용되는 애플리케이션 인프라 빈으로 구분 할 수 있다.

## 컨테이너 인프라 빈을 위한 자바 코드 메타정보

이렇게 세가지로 구분되는 빈은 빈 설정 메타정보를 작성하는 방법과 전략을 각각 다르게 가져갈 수 있다.

**IoC/DI 설정 방법의 발전**

* 스프링 1.x

  스프링 1.x에서는 XML을 이용한 빈 등록 방법을 주로 사용했다. 이때는 XML에서  태그만을 사용할 수 있었기 때문에 세 가지 종류의 빈이 모두  태그로 등록됐다.

  애플리케이션의 규모가 커지고 빈의 개수가 증가하면서 XML 설정파일을 보고 애플리케이션의 구성을 파악하기가 쉽지 않았다.

* 스프링 2.0

  스프링 2.0에서는 사용하기 까다로운 컨테이너 인프라 빈을 손쉽게 사용할 수 있도록 의미 있는 스키마와 네임스페이스를 가진 전용 태그를 제공했고, 필요한 경우에는 직접 커스텀 태그를 만들어서 사용할 수도 있었다.

* 스프링 2.5

  스프링 2.5에는 빈 스캐너와 스테레오타입 애노테이션을 이용한 빈 자동등록 방식과 애노테이션 기반의 의존관계 설정 방법이 등장했다.

  XML에선 더 이상 애플리케이션 로직 빈을 정의하는 이 필요 없어졌다. 그래서 스프링 2.5부터는 XML 설정파일에는 주로 애플리케이션 인프라 빈과 전용 태그를 사용해 정의하는 컨테이너 인프라 빈만 남게 됐고, 애플리케이션 로직 빈의 설정 메타정보는 애노테이션을 이용해 자바코드로 작성하게 됐다.

  하지만 애노테이션을 메타정보로 활용하는 빈 등록과 관계 설정 방식은 외부에서 작성된 클래스를 빈으로 등록할 때는 적용할 수가 없다는 한계가 있었다.

* 스프링 3.0

  스프링 3.0부터는 자바 코드를 이용해 빈 설정정보 또는 빈 설정 코드를 만드는 일이 가능해졌다. XML이나 애노테이션 같은 메타정보를 참고해서 컨테이너가 빈을 만들던 기존 방법과 달리, 코드를 이용해 직접 빈 오브젝트를 생성하고 프로퍼티를 지정할 수 있게 됐다.

* 스프링 3.1

  스프링 3.1에서는 컨테이너 인프라 빈도 자바 코드로 등록할 수 있게 됐다. XML의 전용 태그에 대응되는 새로운 자바 코드 메타정보 작성 방법이 제공된다.

