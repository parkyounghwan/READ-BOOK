# 2021-04-08

**스코프 빈의 사용 방법**

애플리케이션 컨텍스트는 초기화 중에 모든 빈 오브젝트를 생성하고 DI를 진행한다. 그런데 요청 스코프 빈은 컨텍스트 초기화 시점에서는 만들어질 수조차 없다. 아무런 웹 요청도 시작되지 않았기 때문이다. 따라서 요청 스코프 빈을 싱글톤 빈에 그냥 DI 하면 컨텍스트 초기화 중에 에러가 발생할 것이다.

스코프 빈은 프로토타입 빈과 마찬가지로 Provider나 ObjectFactory같은 DL 방식으로 사용해야 한다.

직접 스코프 빈을 DI 하는 대신 스코프 빈에 대한 프록시를 DI 해주면 마치 평범한 싱글톤 빈을 이용하듯이 스코프 빈을 쓸 수 있다.

```java
@Scope("session")
public class LoginUser {
    String loginId;
    ...
}
```

클라이언트는 스코프 프록시 오브젝트를 실제 스코프 빈처럼 사용하면 프록시에서 현재 스코프에 맞는 실제 빈 오브젝트로 작업을 위임해준다.

싱글톤 빈은세션 스코프 빈을 DI 받더라도 하나의 오브젝트밖에 할당이 안 된다. 스코프 프록시는 각 요청에 연결된 HTTP 세션 정보를 참고해서 다른 오브젝트를 사용하게 해준다.

프록시 빈이 인터페이스를 구현하고 있고, 클라이언트에서 인터페이스로 DI받는다면 proxyMode를 ScopedProxyMode.INTERFACES로 지정해주고, 프록시 빈 클래스를 직접 DI 한다면 ScopedProxyMode.TARGET\_CLASS로 지정하면 된다.

```java
@Scope(value="session", proxyMode=ScopedProxyMode.TARGET_CLASS)
public class LoginUser {
```

**커스텀 스코프와 상태를 저장하는 빈 사용하기**

스프링에서는 Scope 인터페이스를 구현해서 새로운 스코프를 작성할 수 있다. 하지만 스코프를 새로 작성하고 적용하는 건 상당히 복잡한 작업이다. 유연하게 정의할 수 있는 스코프를 이용해 상태를 저장해두는 방식의 빈을 본격적으로 사용하려면 스프링 웹플로우나 씸과 같은 프레임워크를 이용하면 된다.

빈에 상태를 저장해두는 방식을 선호하지 않는다면 상태를 갖지 않는 싱글톤 빈을 사용하고 여러페이지를 거치는 동안 유지해야 할 상태정보는 URL 파라미터, 쿠키, 폼 히든 필드와 DB, HTTP 세션에 분산해 저장해두고 코드로 관리해야 한다. 어떤 방식을 사용하든 더 이상 유지할 필요가 없는 상태정보는 가능한 한 빨리 제거해야 한다.

## 기타 빈 설정 메타정보

### **빈 이름**

**XML 설정에서의 빈 식별자와 별칭**

* id

  id를 사용해 빈의 식별자를 지정해야 하는 경우에는 XML의 ID 타입의 기준을 지켜야 한다.

  * id에는 공백이 들어갈 수 없다.
  * 첫 글자는 알파벳과 밑줄\(\_\) 그리고 허용된 일부 언어문자만 사용될 수 있다.
  * 나머지 글자는 알파벳과 밑줄, 그리고 숫자와 점\(.\)을 허용한다. 그 외의 특수문자는 사용할 수 없다.

    빈 선언에 어떠한 식별자도 부여하지 않는다면 스프링 컨테이너가 자동으로 빈의 아이디를 부여해준다.

* name

  name에는 특별한 제약이 없다. 한번에 여러 개의 이름을 지정할 수 있다. 하나의 빈 이름을 부여할 때는 콤마\(.\)나 세미콜론\(;\)을 이용해 각 이름을 구분해준다.

**애노테이션에서의 빈 이름**

클래스에 `@Component` 와 같은 스테레오타입의 애노테이션을 부여해주고 빈 스캐너에 의해 자동인식되도록 만든 경우에는 보통 클래스 이름을 그대로 빈이름으로 사용하는 방법을 선호한다. 클래스 이름 첫 글자만 소문자로 바꾸면 빈 이름이 된다.

`@Configuration` 애노테이션이 달린 클래스의 `@Bean` 메소드를 이용해 빈을 정의하는 경우에는 메소드 이름이 그대로 빈 이름이 된다.

자동 빈 스캔 대상이라면 스테레오타입 애노테이션의 디폴트 엘리먼트 값으로 이름을 지정해주면 된다.

```java
@Component("myUserService")
public class UserService {
```

`@Bean` 애노테이션의 name 엘리먼트를 이용할 수 있다.

```java
@Configuration
public class Config {
    @Bean(name="myUserDao")
    public UserDao userDao() {
```

### 빈 생명주기 메소드

**초기화 메소드**

초기화 메소드는 빈 오브젝트가 생성되고 DI 작업까지 마친 다음에 실행되는 메소드를 말한다. 오브젝트의 기본적인 초기화 작업은 생성자에서 진행하면 된다. 하지만 DI를 통해 모든 프로퍼티가 주입된 후에야 가능한 초기화 작업도 있다. 이런 경우 사용할 수 있는 것이 초기화 메소드다.

* 초기화 콜백 인터페이스

  InitializingBean 인터페이스를 구현해서 빈을 작성하는 방법. InitializingBean의 afterPropertiesSet\(\) 메소드는 이름 그대로 프로퍼티 설정까지 마친 뒤에 호출된다. 하지만 이 방법은 별로 권장되지 않는다. 애플리케이션 빈 코드에 스프링 인터페이스를 노출하기 때문이다.

* init-method 지정

  XML을 이용해 빈을 등록한다면  태기의 init-method 애트리뷰트를 넣어서 초기화 작업을 수행할 메소드 이름을 지정할 수 있다. 예를 들면 다음 빈 설정은 DI 작업까지 마친 뒤에 initResource\(\) 메소드가 실행되도록 선언한 것이다.

  ```markup
    <bean id="myBean" class="MyBean" init-method="initResource"/>
  ```

* @PostConstruct

  초기화를 담당할 메소드에 `@PostConstruct` 애노테이션을 부여해주기만 하면 된다. `@PostConstruct` 는 자바의 표준 공통 애노테이션이므로 스프링 콜백 인터페이스를 사용하는 것보다 상대적으로 부담이 적으면서, 코드에서 초기화 메소드가 존재한다는 사실을 쉽게 파악할 수 있으므로 XML의 init-method 설정보다 직관적이다.

* @Bean\(init-method\)

  `@Bean` 메소드를 이용해 빈을 정의하는 경우에는 `@Bean` 애노테이션의 init-method 앨리먼트를 사용해서 초기화 메소드를 지정할 수 있다. 의 init-method와 같은 방법이라고 생각하면 된다.

**제거 메소드**

제거 메소드는 컨테이너가 종료될 때 호출돼서 빈이 사용한 리소스를 반환 하거나 종료 전에 처리해야 할 작업을 수행한다.

* 제거 콜백 인터페이스

  DisposableBean 인터페이스를 구현해서 destroy\(\)를 구현하는 방법이다.

* destroy-method

   태그에 destroy-method를 넣어서 제거 메소드를 지정할 수 있다.

* @PreDestory

  컨테이너가 종료될 대 실행될 메소드에 @PreDestroy를 붙여주면 된다.

* @Bean\(destroyMethod\)

  `@Bean` 애노테이션의 destroyMethod 앨리먼트를 이용해서 제거 메소드를 지정할 수 있다.

  **팩토리 빈과 팩토리 메소드**

생성자 대신 오브젝트를 생성해주는 코드의 도움을 받아서 빈 오브젝트를 생성하는 것을 팩토리 빈이라고 부른다. 팩토리 빈 자신은 빈 오브젝트로 사용되지 않는다. 대신 빈 오브젝트를 만들어주는 기능만 제공해줄 뿐이다.

* FactoryBean 인터페이스

  FactoryBean 인터페이스를 구현해서 다이내믹 프록시를 생성하는 getObject\(\) 메소드를 구현하고 팩토리 빈으로 등록해서 사용한다.

  보통 팩토리 빈은 기술 서비스 빈이나 기반 서비스 빈을 활용할 때 주로 사용된다. 따라서 스프링 인터페이스를 구현하는 것이 불편하지 않다면 사용하기 적당하다.

* 스태틱 팩토리 메소드

  클래스의 스태틱 메소드를 호출해서 인스턴스를 생성하는 방식. 스태틱 메소드를 호출해서 빈 오브젝트를 생성해야 한다면  태그에 사용할 수 있는 factory-method 애트리뷰트를 이용하는 것이 편리하다.

* 인스턴스 팩토리 메소드

  FactoryBean 인터페이스를 구현한 팩토리 빈이 바로 팩토리 빈 오브젝트의 메소드를 이용해 빈 오브젝트를 생성하는 대표적인 방법이다. 하지만 FactoryBean이라는 스프링의 인터페이스에 종속적이라는 단점이 있다.

* @Bean 메소드

  자바 코드에 의한 빈 등록 방식에서 사용하는 @Bean 메소드도 일종의 팩토리 메소드다. 스프링 컨테이너가 @Bean 메소드를 실행해 빈 오브젝트를 가져오는 방식이기 때문이다.

